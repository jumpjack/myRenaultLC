<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="PSPad editor, www.pspad.com">
  <title>Unofficial MyRenault dashboard for browsers</title>


	<script src="myrenault-public.js?dummy=new"></script>
	<script src="endpoints.js?dummy=new"></script>
	<script src="errors.js?dummy=new"></script>
	<script src="payloads.js?dummy=new"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

  <script>

// 2.4.0 Removed use of myp.php generic proxy, now using specific PHPO login performed by gigya-login.php
// 2.3.0 Cleaned up code for login process
// 2.2.4 Fixed bug of hardcoded gigya server
// 2.2.3 Improved error management during login process
// 2.2.2 Fixed for Firefox support; improved interface.
// 2.2.1 Added plugStatus and chargingStatus texts
// 2.2.0 Added automatic initial query of all endpoints
// 2.1.0 Added "getAllData()" function (to be optimized). Removed dead/useless code.
// 2.0.0 New interface, more user friendly, with preloaded payloads, meaningful endpoints names, login process status,...
// 1.6.1 Added further payloads
// 1.6.0 Implemented predefined payloads for actions
// 1.5.0 New Axios method implemented for login and query (to be cleaned up)
// 1.4.0 Added plenty of debug error messages during login; cleaned up page and code; added textareas for endpoint and payload for manual testing
// 1.3.0 Addes some test buttons and functions for actions; implemented Axios for actions
// 1.1.1 Fixed bug of post/get; actions not working yet.
// 1.1.0 Added actions support
// 1.0.2 Reordered enpoints, enhanced output
// 1.0.1 Oscurato VIN in output
// 1.0.0 Prima versione pubblica


GIGYA_API_KEY = null;
KAMEREON_KEY = null;

JWTextracted = null;
countdownStarted = false;
lastStep = "start";


empty = "";
slash = "\\";

results = [];

endpointResponseTemplate =  endpointsList.filter(vals=>vals.name === "battery-status")[0].response;// Find element named "battery-status"
allowedPlugValues = endpointResponseTemplate.filter(vals=>vals.name === "plugStatus")[0].values; // Find element named "plugStatus"
allowedChargingValues = endpointResponseTemplate.filter(vals=>vals.name === "chargingStatus")[0].values; // Find element named "chargingStatus"



// To get data from an item undefinely nested inside an object:
// https://stackoverflow.com/posts/43849204/timeline
const resolvePath = (object, path, defaultValue) => path
   .split('.')
   .reduce((o, p) => o ? o[p] : defaultValue, object)


function init() {
	gigyaurl = data.servers.gigyaProd.target;
	GIGYA_API_KEY= newData.servers.gigyaProd.apikey;
	kamereonurl = data.servers.wiredProd.target;
	KAMEREON_KEY = newData.servers.wiredProd.apikey;
	GIGYA_PHP_LOGIN = gigyaPhpLogin.value;
/*	PROXY_SCRIPT = proxyScript.value;
	PROXY_PARAMETERS= proxyParams.value;
	PROXY_STRING = PROXY_SCRIPT + PROXY_PARAMETERS;
*/
}

function createJSrefreshLinks() {
// To prevent caching of old .js files, creates links to JS with fake parameters: click on the link to force refresh of scripts
	timestamp = (new Date()).getTime();
	console.log(timestamp);
	link1 = "myrenault-public.js?dummy=" + timestamp;
	link2 = "endpoints.js?dummy=" + timestamp;
	link3 = "errors.js?dummy=" + timestamp;
	link4 = "payloads.js?dummy=" + timestamp;
	links.innerHTML = "" +
	"<a href='"+ link1 + "'>myrenault</a><br>" +
	"<a href='"+ link2 + "'>endpoints</a><br>" +
	"<a href='"+ link3 + "'>errors</a><br>" +
	"<a href='"+ link4 + "'>payloads</a><br>";
}

function fillPayload() {
console.log("Funziona o no?");
    actionPayloadSpan.value = JSON.stringify(samplePayloads[payloadsList.selectedIndex].pldContents, null, 4);
    actionEndpoint.value = "actions/" + samplePayloads[payloadsList.selectedIndex].associatedAction;
    payloadTested.innerHTML = samplePayloads[payloadsList.selectedIndex].testedOk;
}


function loadPayloads() {
	var lst = payloadsList;
	for (var i=0; i<samplePayloads.length; i++) {
		opt = document.createElement("option");
		opt.setAttribute("value", samplePayloads[i].pldName);
		opt.text =  samplePayloads[i].pldName;
		lst.appendChild(opt);
	}
}


function fillEndPoint() {
	endpoint.value = endpointsList[EP_list.selectedIndex].url;
    endpointDescription.innerHTML = endpointsList[EP_list.selectedIndex].description;
    actionPayloadSpan.value = JSON.stringify(endpointsList[EP_list.selectedIndex].payload,null,4);
}


function loadEndpoints() {
	var lst = EP_list;
	for (var i=0; i < endpointsList.length; i++) {
		opt = document.createElement("option");
		opt.setAttribute("value", endpointsList[i].name);
		opt.text =  endpointsList[i].name;
		lst.appendChild(opt);
	}
}


function callByClick(endp, libVer) {
	// Called when clicked on endpoint
		endpoint.value = endp;
		output.value = "";
		log.value = "";
		//startCountdown();
		justQuery(libVer);
}


function request(url, setMyHeader, payload, requestType) {
//console.log("REQ - Processing " , url , "...");
console.log("REQ - payload ricevuto: '" , payload , "'");

  return new Promise(function (resolve, reject) {
	const xhr = new XMLHttpRequest();
	xhr.timeout = 2000;

	xhr.onreadystatechange = function(e) {
		if (xhr.readyState === 4) {
			// Response received
			if (xhr.status === 200) {
				// Positive response received
				resolve(xhr.response);
			} else {
				console.log("REQ - Error at step ' " + lastStep + "' for URL " + url + ": " , xhr.status);
				log.value += "\n\nREQ - Error at step ' " + lastStep + "' for URL " + url + ":\n\nERROR " + xhr.status;
				if (errors[xhr.status] != null) {
					console.log(errors[xhr.status]);
					log.value += "\nREQ - " + errors[xhr.status].message + "\n" + errors[xhr.status].description;
				} else {
					log.value += "\nREQ - Sorry, no further info on this error.\n";
				}
				reject(xhr.status)
			}
			} else {
				// Prcessing....
			// console.log("Ongoing,Status=", xhr.readyState);
		}
	}


	xhr.ontimeout = function () {
		console.log("REQ - XHR timeout error.\n");
		log.value += "REQ - XHR timeout error.\n";
		reject('timeout');
	}


	xhr.onerror = function (e) {
		console.log("REQ - XHR  error: ", e , "\n");
		log.value += "REQ - XHR  error: ", e , "\n";
		reject('error');
	}


	if (requestType == "get") {
		xhr.open('get', url  , true)
	} else {
		xhr.open('post', url  , true)
	}


	if (setMyHeader === true) {
		xhr.setRequestHeader("x-gigya-id_token",JWT.value);
		xhr.setRequestHeader("apikey",KAMEREON_KEY);
		xhr.setRequestHeader("Content-type","application/vnd.api+json");
		console.log("REQ - With header, type: ", requestType);
	} else {
		console.log("REQ - Without header, type: ", requestType);
	}


	if ((payload != null) && (payload.length > 0)) {
		xhr.send(payload);
		console.log("REQ - With payload, type: ", requestType);
	} else {
        xhr.send();
		console.log("REQ - Without payload, type: ", requestType);
	}

  } // Promise function end
  ) // Promise end
}

function getAllData() {
 kamereonGet(JWT.value, "cockpit",  1);
 kamereonGet(JWT.value, "location",  1);
 kamereonGet(JWT.value, "battery-status",  1);
 kamereonGet(JWT.value, "battery-status",  2);
 kamereonGet(JWT.value, "hvac-status",  1);
 kamereonGet(JWT.value, "hvac-settings",  1);
 kamereonGet(JWT.value, "hvac-schdule",  1);
 kamereonGet(JWT.value, "charge-mode",  1);
 kamereonGet(JWT.value, "charging-settings",  1);
 kamereonGet(JWT.value, "charge-schedule",  1);
 console.log(results);
}

function justQuery(libraryVersion) {
	if (login5.innerHTML !== "OK") alert("Not logged in!");
	lastStep = "justQuery v." + libraryVersion;
	log.value += "Endpoint '" + endpoint.value + "', library version: " + libraryVersion + ":\n";
	output.value = "";
	log.value += "Sending query...\n";
	console.log("=== DIRECT QUERY");

	if (endpoint.value.indexOf("actions") >= 0) {
		console.log("Final POST result: " , kamereonPost(JWT.value, endpoint.value, actionPayloadSpan.value, libraryVersion, "", ""));
	} else {
		console.log("Final GET result: " ,  kamereonGet(JWT.value, endpoint.value,  libraryVersion));
	}


}



function sendManualUrl() {
	lastStep = "sendManualUrl";
  log.value = "Manual url:\n";
	log.value += manualUrl.value + "\n";
	console.log("=== sendManualUrl");
	queryUrl = manualUrl.value;
console.log("finalQueryUrl ", queryUrl);
	const sendQuery = request(queryUrl, true, actionPayloadSpan.value, "get");
	sendQuery
	  .then(showResults)
	  .catch(vehicleError)
	return ("query finished.");

}



function mainold() {
	output.value = "";
  	log.value = "Logging in...\n";
	cookieValue.value="waiting...";
	JWT.value = "waiting...";
	personId.value = "waiting...";
	accountId.value = "waiting...";
	accountId2.value = "waiting...";
	
	init();
	login1.innerHTML = "-";
	login2.innerHTML = "-";
	login3.innerHTML = "-";
	login4.innerHTML = "-";
	login5.innerHTML = "-";
	login6.innerHTML = " logging in...";

	loginUrl =  gigyaurl + "/accounts.login?loginID=" + username.value + "&password=" + password.value + "&apikey=" + GIGYA_API_KEY;
	if (PROXY_STRING !== "") {
		finalLoginURL =  PROXY_STRING + encodeURIComponent(loginUrl);
	} else {
		finalLoginURL = loginUrl;
	}

console.log("LOGIN URL: ", finalLoginURL);
// VERSIONE CON AXIOS:
return axios.post(
		finalLoginURL,
		null, // No payload required for login
		{	headers: {'apikey': KAMEREON_KEY}	}
	)
	.then(response => {
console.log("POST result for Renault login:", response);
		//output.value = "\nPOST result  for lOGIN:\n" + (JSON.stringify(response.data, null, 4));
		debugCheck = response;

		//////////////////////////
		checkRenaultLoginResult(response); // Only if check is successful the function calls next functions to retrieve JWT, Person, Account, VIN
		//////////////////////////

	})
	.catch(
		function (error) {
			log.value += "\nERROR for LOGIN:\n" + error + "\n";
			console.log("ERROR for LOGIN:\n" , error);
			login1.innerHTML = "ERR_LOGIN";
			return { status : "error", data : error };
		}
	);
}


function main() {
	output.value = "";
  	log.value = "Logging in...\n";
	cookieValue.value="waiting...";
	JWT.value = "waiting...";
	personId.value = "waiting...";
	accountId.value = "waiting...";
	accountId2.value = "waiting...";

	init();
	login1.innerHTML = "-";
	login2.innerHTML = "-";
	login3.innerHTML = "-";
	login4.innerHTML = "-";
	login5.innerHTML = "-";
	login6.innerHTML = " logging in...";


return axios.post(
		GIGYA_PHP_LOGIN + '?gigyakey=' + GIGYA_API_KEY + '&gigyasite=' + gigyaurl +  '&username=' + username.value + '&password=' + password.value + '&kamereon=Ae9FDWugRxZQAGm3Sxgk7uJn6Q4CGEA2',
		null, // No payload required for login
		{	headers: null	}
	)
	.then(response => {
console.log("POST result for my login:", response);
		//output.value = "\nPOST result  for lOGIN:\n" + (JSON.stringify(response.data, null, 4));
		debugCheck = response;

		//////////////////////////
		//checkRenaultLoginResult(response); // Only if check is successful the function calls next functions to retrieve JWT, Person, Account, VIN
		//////////////////////////
		cookieValue.value = response.data.loginData.cookie;
		JWT.value = response.data.loginData.JWT;
		personId.value = response.data.loginData.personId;
		getAccountId();
	})
	.catch(
		function (error) {
			log.value += "\nERROR for MAIN:\n" + error + "\n";
			console.log("ERROR for MAIN:\n" , error);
			login1.innerHTML = "ERR_LOGIN";
			return { status : "error", data : error };
		}
	);

}

function checkRenaultLoginResult(loginResponse) {
	lastStep = "checkRenaultLoginResult";
	log.value += "Checking Renault login results...\n";
	console.log("Checking Renault login results...",loginResponse);

	try {
		if (loginResponse.data.errorCode === 400002) {
			console.log("ERR 002 - Cannot retrieve Renault cookie, missing login data:\n", loginResponse);
			log.value += "ERR 002 - Cannot retrieve Renault cookie, missing login data:\n"+ loginResponse.errorDetails + "\n";
			login1.innerHTML = "ERR-002";
			return {status : "error 002", data : loginResponse};
		}


		if (loginResponse.data.errorCode === 403042) {
			console.log("ERR 042 - Cannot retrieve Renault cookie, invalid login data:\n", loginResponse);
			log.value += "ERR 042 - Cannot retrieve Renault cookie, invalid login data:\n"+ loginResponse.errorDetails + "\n";
			login1.innerHTML = "ERR-042";
			return {status : "error 042", data : loginResponse};
		}


		if (loginResponse.data.errorCode != "0") {
			console.log("ERR unknwon - Cannot retrieve Renault cookie, login failed:\n", loginResponse);
			log.value += "ERR unknown - Cannot retrieve Renault cookie, login failed:\n"+ loginResponse + "\n";
			login1.innerHTML = "ERR-UNK";
			return {status : "error unknown", data : loginResponse};

		}

		console.log("Credentials accepted, Renault cookie retrieved: ", loginResponse.data.sessionInfo.cookieValue);
		log.value += "Credentials accepted, Renault cookie retrieved.\n";
		login1.innerHTML = "OK";
		cookie = loginResponse.data.sessionInfo.cookieValue;
		cookieValue.value = loginResponse.data.sessionInfo.cookieValue;
		renaultUID = loginResponse.data.UID; // needed for Axios calls?

		// Renault cookie retrieved; next step: get JWT token:
	//////////////////////////
		getJWTtoken();
	//////////////////////////

		return {status : "ok", data : "Retrieving JWT..."};
	} catch (error) {
		console.log("ERR 112 - Cannot retrieve Renault cookie, error during login:\n", error,loginResponse);
		log.value += "ERR 112 - Cannot retrieve Renault cookie,  error during login:\n";
		return {status : "error 112", data : loginResponse};
	}
}




function getJWTtoken() {
	lastStep = "getJWTtoken";
	if (cookieValue.value.indexOf("error") >= 0) {
		console.log("Cannot proceed and ask for JWT due to failed Renault login: ", error);
		log.value += "Cannot proceed and ask for JWT due to failed Renault login: " + error + "\n";
		return { status: "error", data: "Cannot proceed and ask for JWT due to failed Renault login: " + cookieValue.value} ;
 }

	JWTheaders = {
		'login_token': cookieValue.value,
		'apikey': KAMEREON_KEY,
	    'fields' : 'data.personId,data.gigyaDataCenter',
		'expiration': 87000
	};


console.log("====JWT");
	console.log("Logged in, searching for JWT...");
	log.value += "Logged in, searching for JWT...\n";
	JWTurl = gigyaurl + "/accounts.getJWT?fields=data.personId%2Cdata.gigyaDataCenter&expiration=600&APIKey=" + GIGYA_API_KEY +
	"&sdk=js_latest&authMode=cookie&pageURL=https%3A%2F%2Fmyr.renault.it%2F&sdkBuild=12426&format=json&login_token=" +	cookieValue.value;
	if (PROXY_STRING !== "") {
		finalJWTurl =  PROXY_STRING + encodeURIComponent(JWTurl);
	} else {
		finalJWTurl = JWTurl;
	}
// VERSIONE CON AXIOS:
		return axios.post(
			finalJWTurl,
			null, // No payload required for retrieving JWT
			{
				headers: JWTheaders
	   		})
			.then(response => {
 				//output.value = "\nPOST result:\n" + (JSON.stringify(response.data, null, 4));
                //console.log("response.id: "+ response.data.id_token);
				debugCheck = response;
				if (checkJWT(response.data).status.toUpperCase() === "OK") {; // Not async, just extract JWT string from response, hence not blocking.
//////////////////////
	                getPersonId(); // Async function: can proceed to next step (getAccountId) only after receiving response.
//////////////////////
					return { status: "ok", data: "Retrieving person id..." };
				} else {
					console.log("ERROR: Invalid JWT response.");
					log.value += "\nERROR: Invalid JWT response.\n";
                    return { status: "err", data: "Invalid JWT response" };
				}
			})
			.catch(
			  function (error) {
				log.value += "\nERROR 001 for POST while getting JWT, please see console for details.\n";
				console.log("ERROR 001 for POST while getting JWT:\n",  error);
				login2.innerHTML = "ERR_POST1";
				console.log("POST ERROR 001:" , error)
				return { status : "error", data: "POST ERROR 001b:" + error };
			  }
			);

}


function getPersonId() {
	lastStep = "getPersonId";
console.log("====personId");
	console.log("Found JWT, searching for Person Id...");
	log.value += "Found JWT, searching for Person Id...\n";
	var personUrl = gigyaurl + "/accounts.getAccountInfo?apikey=" + GIGYA_API_KEY + "&login_token=" + cookieValue.value;
//	var finalPersonurl= PROXY_STRING + encodeURIComponent(personUrl);
	if (PROXY_STRING !== "") {
		finalPersonurl =  PROXY_STRING + encodeURIComponent(personUrl);
	} else {
		finalPersonurl = personUrl;
	}

	personHeaders = {
		'login_token': cookieValue.value,
		'apikey': KAMEREON_KEY,
		'expiration': 87000
	};


// VERSIONE CON AXIOS:
		return axios.post(
			finalPersonurl,
			null, // No payload required for retrieveing personId
			{
				headers: null
	   		})
			.then(response => {
 				//console.log("POST result for Person:" + (JSON.stringify(response.data, null, 4)));
 				//output.value = "\nPOST result for Person:\n" + (JSON.stringify(response.data, null, 4));
                console.log("response.id: "+ response.data.data.personId);
                personIdResult = checkPersonId(response);
				if (personIdResult.status.toUpperCase() == "OK") {
/////////////////////////////////
					getAccountId(); // After receiving personId, proceed with getAccountId
/////////////////////////////////
					return { status: "ok", data: "Retrieving account id...." };
				 } else {
					console.log("Account id error 114:" , personIdResult);
					log.value += "\nAccount id error 114\n";
				 }
			})
			.catch(
			  function (error) {
				log.value += "\nERROR 002 for POST while getting personId:\n" + error + "\n";
				console.log("ERROR 002 for POST while getting personId:\n" , error);
				login3.innerHTML = "ERR_POST2";
				return( {status: "error", data : "ERROR 002b:" + JSON.stringify(error, null, 4) } );
			  }
			);
}

function getAccountId() {
	lastStep = "getAccountId";
	log.value += "Found Person Id, searching for accounts...\n";
console.log("====accountId");
	accountUrl = kamereonurl + "/commerce/v1/persons/" +
	personId.value +
	"?apikey=" + KAMEREON_KEY +
	"&country=" + country.value;

// Kemereon server has no CORS restrictions
/*	if (PROXY_STRING !== "") {
		finalAccounturl =  PROXY_STRING + encodeURIComponent(accountUrl);
	} else {
		finalAccounturl = accountUrl;
	}
*/
console.log("URL PER ACCOUNT: " + accountUrl);

	accountHeaders = {
		'apikey': KAMEREON_KEY,
        'x-gigya-id_token' :  JWT.value
	};

// VERSIONE CON AXIOS:
	return axios.get(
		accountUrl,
			{
				headers: accountHeaders
			}
		)
		.then(response => {
			accountIdExtractionResut = extractAccountId(response.data); // Not blocking, just extracting string from response.
///////////////////////////////
			getVINs(accountIdExtractionResut); //After retrieving accountId, proceed wirh getVin
///////////////////////////////
			return {status: "ok", data : "Account retrieved, retrieving VIN..."};
		})
		.catch( response => {
		  function pippo (error,response) {
			log.value += "\nERROR 002b for POST while getting accountId:\n" + error + "\n";
			console.log("ERROR 002b for POST while getting accountId:\n", error, response);
			login4.innerHTML = "ERR_POST2";
	        return ({ status: "POST ERROR 002b", data: response.data });
		  }
		  }
		);
}



function getVINs(accountIdResult) {
	lastStep = "getVINs";
console.log("=== VIN");
	if (accountIdResult.status.toUpperCase().indexOf("OK") === false) {
		log.value += "\nERROR 004: accountId not found, cannot extract VIN, please see console for details.";
		console.log("ERROR 004: accountId not found, cannot extract VIN: ", accountIdResult);
	  	login1.innerHTML = "ERR_EXTR_ACC";
		return ({ status: "ERROR 004", data: accountIdResult });
	} else {
		//   go on
	}
	console.log("Found account, searching for VIN...");
	log.value += "Found account, searching for VIN...\n";

	vehiclesListQueryUrl = kamereonurl + "/commerce/v1/accounts/" +
		accountId2.value +
		"/vehicles" +
		"?apikey=" + KAMEREON_KEY +
		"&country=" + country.value;
// Kemereon server has no CORS restrictions
/*	if (PROXY_STRING !== "") {
		finalVehiclesListQueryUrl =  PROXY_STRING + encodeURIComponent(vehiclesListQueryUrl);
	} else {
		finalVehiclesListQueryUrl = vehiclesListQueryUrl;
	}
*/
console.log("vehiclesListQueryUrl ", vehiclesListQueryUrl);

	accountHeaders = {
		'apikey': KAMEREON_KEY,
        'x-gigya-id_token' :  JWT.value
	};

// VERSIONE CON AXIOS:
	return axios.get(
		vehiclesListQueryUrl,
			{
				headers: accountHeaders
			}
		)
		.then(response => {
			//console.log("POST result for VIN:" + (JSON.stringify(response.data, null, 4)));
			//output.value = "\nPOST result for VIN:\n" + (JSON.stringify(response.data, null, 4));
			console.log("response VIN: ", response);
			checkVIN(response.data);
		})
		.catch(
		  function (error) {
			log.value += "\nERROR 003 for POST while getting VIN:\n" + error + "\n";
			console.log("ERROR 003 for POST while getting VIN:\n" + error);
			console.log("POST ERROR 003:" ,error)
		  	login1.innerHTML = "ERR_POST";
			return ({ status: "POST ERROR 003 (VIN)", data: response.data });
			}
		);
}




////////////////////////////////////////////////
function getVehicleData() {
	lastStep = "getVehicleData";
	log.value +="\n\nLOGIN SUCCESSFUL.\nSending query...\n";
console.log("=== QUERY");
	if ((endpoint.value).indexOf("?") >0 ) { // in case quetion mark is included in manual input...
		QUESTION_MARK = "&";
	} else  {
		QUESTION_MARK = "?";
	}

	queryUrl = kamereonurl + "/commerce/v1/accounts/" +
		accountId.value +
		"/kamereon/kca/car-adapter/v1/cars/" + MY_VIN.value +
		"/" +
		endpoint.value +
		QUESTION_MARK +
		"apikey=" + KAMEREON_KEY +
		"&country=" + country.value;

console.log("finalQueryUrl ", queryUrl);

	queryHeaders = {
		'apikey': KAMEREON_KEY,
        'x-gigya-id_token' :  JWT.value,
        'Content-type'  : 'application/vnd.api+json'
		//'expiration': 87000
	};

	actionPayload = actionPayloadSpan.value;


// VERSIONE CON AXIOS:
		return axios.post(
			queryUrl,
			actionPayload,
			{
				headers: queryHeaders
	   		})
			.then(response => {
 				console.log("Axios POST result for vehicle data:" + (JSON.stringify(response.data, null, 4)));
 				output.value = "\nAxios POST result for vechile data:\n" + (JSON.stringify(response.data, null, 4));
                console.log("response: ", response);
				return ({ status: "OK", data: response });
			})
			.catch((error) => {
			      if (error.response) {
			        console.log(error.response);
					wholeError = error.response;
                    errorMessage = wholeError.data.errors[0].errorMessage;
                    cleanedErrorMessage = errorMessage.split(slash).join(empty);
                    JSONerrorMessage = JSON.parse(cleanedErrorMessage);
					console.log(">>>> getVehicleData - Final error:", JSONerrorMessage);
					output.value = JSON.stringify(JSONerrorMessage, null, 4);
					console.log("QUERY FINISHED");
					return ({ status: "VIN ERROR", data: response });
			      }
			    }

			);
}
////////////////////////////////////////////////









function checkJWT(JWTresponse) {
	lastStep = "checkJWT";
//console.log("JWTresponse:" , JWTresponse);
//	var JSONdata = JSON.parse(JWTresponse);
//console.log("Extracted:" , JSONdata);

	console.log("JWT response received. Analysing...", JWTresponse);
	log.value +="JWT response received. Analysing...\n";

	try {
		JWT.value = JWTresponse.id_token;
		login2.innerHTML = "OK";

		loginPayloadForReqbin.innerHTML = "<pre>apikey :" + KAMEREON_KEY + "<br>" +
								"Content-type : application/vnd.api+json<br>" +
								"x-gigya-id_token : " + JWTresponse.id_token + "<br></pre>";
		return {status: "OK", data : JWTresponse};
	} catch (error) {
		return {status: "error in JWT check", data : JWTresponse};
	}
}




function checkPersonId(personIdResponse) {
	lastStep = "checkPersonId";
	console.log("========personId extraction");
	console.log("personId response received, analysing..." , personIdResponse);
	log.value += "personId response received, analysing...\n";

	try {
		if (personIdResponse.data.errorCode != "0") {
			console.log("ERR unknwon - Cannot extract personId from response:\n", personIdResponse);
			log.value += "ERR unknown - Cannot extract personId from response:\n" +  personIdResponse;
			login3.innerHTML = "ERR";
			return {status: "error" , data : personIdResponse};
		}

		console.log("personId successfully extracted: " + personIdResponse.data.data.personId);
		log.value += "personId successfully extracted.\n";
		login3.innerHTML = "OK";
		personId.value = personIdResponse.data.data.personId;
		return {status : "OK", data : personIdResponse};
	} catch (error) {
		console.log("Error extracting personid" , personIdResponse);
		log.value += "\nError extracting personid.\n";
		return {status: "error", data : personIdResponse};
	}
}



function extractAccountId(accountIdResponse) {
	lastStep = "extractAccountId";
	console.log("========accountId extraction", accountIdResponse);
	console.log("accountId response received, analysing...");// , personIdResponse);
	log.value += "accountId response received, analysing...\n";
	//var JSONdata = accountIdResponse;

	if (accountIdResponse.accounts === null) {
		console.log("ERR unknwon - No accounts found in response:\n", accountIdResponse);
		log.value += "ERR unknown - No accounts found in response:\n" +  JSON.stringify(accountIdResponse, null, 4);
		login4.innerHTML = "JSON_ERR";
        
		return ({ status: "error", data: accountIdResponse });
	}

	try {
		accountId.value = accountIdResponse.accounts[0].accountId;
		accountIdType.value = accountIdResponse.accounts[0].accountType;
		accountId2.value = accountIdResponse.accounts[1].accountId;
		accountId2Type.value = accountIdResponse.accounts[1].accountType;
		login4.innerHTML = "OK";
		console.log("accountId successfully extracted", accountId.value, accountId2.value);
		log.value += "accountId successfully extracted.\n";
		return ({ status: "OK", data: accountIdResponse });
	} catch (error) {
		console.log("\nJSON ERROR - Cannot extract accountId from response:\n", accountIdResponse);
		log.value += "\nJSON ERROR - Cannot extract accountId from response:\n" +  JSON.stringify(accountIdResponse, null, 4);
		login4.innerHTML = "JSON_ERR2";
		return ({ status: "error in accountId extraction", data: accountIdResponse });
	}

}



function checkVIN(VINResponse) {
	lastStep = "checkVIN";
	console.log("============ VIN:" , VINResponse);
	console.log("VIN response recevied, analysing..."); // , VINResponse);
	log.value += "VIN response recevied, analysing...\n";

	if (VINResponse.vehicleLinks === null) { // No error=0 in case of success!
		console.log("ERR unknwon - Cannot extract VIN from response, no vehicles array:\n", VINResponse);
		log.value += "\nERR unknown - Cannot extract VIN from response, no vehicles array, please see console for dertails.\n";
		login5.innerHTML = "ERR";
		login6.innerHTML = "<b>LOGIN FAILED<b>";
		return ({ status: "error in VIN extraction, no vehicles array", data: VINResponse });
	}

	try {
		MY_VIN.value = VINResponse.vehicleLinks[0].vin;
		login5.innerHTML = "OK";
		loginTime = new Date();
		loginString = loginTime.getHours() + ":" + loginTime.getMinutes();
		login6.innerHTML = "<b>Successfully logged in at " + loginString + "</b>";
		startCountdown();

		var testlink = kamereonurl + "/commerce/v1/accounts/" +
			accountId.value +
			"/kamereon/kca/car-adapter/v1/cars/" + MY_VIN.value +
			"/" +
			"cockpit" +
			"?" +
			"apikey=" + KAMEREON_KEY +
			"&country=" + country.value;

		testUrlReqbin.innerHTML = "<a href='" + testlink + "'>" + testlink + "</a><br>" ;

////////////////// LOGIN PROCESS COMPLETED //////////////////
		console.log("VIN successfully extracted.");
		console.log("=== LOGIN PROCESS SUCCESSFULLY COMPLETED ===.");
		log.value += "VIN successfully extracted.\n";
		log.value += "LOGIN COMPLETE.\n";
		output.value = "\nLogin successful, click on 'download data' button to retrieve data.\n";
////////////////// ///////////////////////  //////////////////

	} catch {
		console.log("JSON error 2 - Cannot extract VIN from response:\n", VINResponse);
		log.value += "\nJSON error 2 - Cannot extract VIN from response:\n" +  JSON.stringify(VINResponse, null, 4);
		login5.innerHTML = "JSON_ERR2";
		login6.innerHTML = "<b>LOGIN FAILED<b>";
		return ({ status: "VIN_ERR3", data: VINResponse });
	}
}



function showResults(queryResponse) {
	lastStep = "showResults";
	console.log("queryResponse:", queryResponse);
//	document.getElementById("status").innerHTML = queryResponse;
	JSONdataFinal = JSON.parse(queryResponse);
	console.log("Extracted:" , JSONdataFinal);
	output.value = "Results for endpoint " + endpoint.value + ":\n" + (JSON.stringify(JSONdataFinal, null, 4)).replace(MY_VIN.value,"xxxMYVINxxx"); ;


}



function errore(e) {
	console.log("Errore in login:" + e);
	log.value += "\nErrore in login:" + e;
	return ("Errore");
}



function JWTerror(e) {
	console.log("Errore JWT: " + e);
	log.value += "\nErrore in JWT:" + e;
	JWT.value="JWT error";
	return ("!!!!!!!!!!!!Errore JWT");
}



function personIdError(e) {
	console.log(e);
	log.value += "\nErrore in personId:" + e;
	personId.value = "!!!!!!!!!!!! Person Id error";
	
	return ("Errore PersonId");
}



function accountIdError(e) {
	console.log(e);
	accountId.value = "!!!!!!!!!!!! Account ID error";
	log.value += "\nErrore in accountId:" + e;
	return ("Errore accountId");
}


function vehicleError(e) {
	console.log(e);
	log.value += "\nVehicle query error";
	return ("Errore PersonId");
}




function startCountdown() {
 if (countdownStarted) return;
 countdownStarted = true;
  var minute = 10;
  var sec = 59;
  if (myInterval != null) clearInterval(myInterval);
  var myInterval=setInterval(function() {
	document.getElementById("countdown").innerHTML = minute + " : " + sec;
	sec--;
	if (sec == 00) {
	  minute --;
	  sec = 59;
	  if (minute == 0) {
		clearInterval(myInterval);
		login1.innerHTML = "Expired";
		login2.innerHTML = "Expired";
		login3.innerHTML = "Expired";
		login4.innerHTML = "Expired";
		login5.innerHTML = "Expired";
		login6.innerHTML = "Expired";
		alert("New login required!");
		countdownStarted = false;
	  }
	}
  }, 1000);
}

function manageOutput(response, path) {
console.log("output response",response);
console.log("output path", path);
console.log("DEBUG:",response.data);
pippo = response.data;
	console.log("Axios GET successful.", response);// for '" + path +  "' with version " + version + "':" + (JSON.stringify(response.data, null, 4)).replace(MY_VIN.value, "xxx MY VIN xxx"));
	output.value = "\nAxios GET successful:\n" +  (JSON.stringify(response.data, null, 4)).replace(MY_VIN.value, "xxx MY VIN xxx");
	selectedEndpoint  = endpointsList[EP_list.selectedIndex];
	for (const key in response.data) {
	    console.log(`${key}: ${response.data[key]}`);
        results[`${key}`] = `${response.data[key]}`;
		stringToWrite = ("<tr><td>`${key}`</td><td>`${response.data[key]}`</td><td>" + path + "</td></tr>").toUpperCase();
		currentTable = finalResults.innerHTML.toUpperCase();
		fieldName =  `${key}`;
		fieldValue =  `${response.data[key]}`;
		if (fieldValue.indexOf("object") >= 0 ) { // Specific processing in case parameter value is an bject (tipically schedules)
			fieldValue = JSON.stringify(response.data, null, 4);
            fieldValue = fieldValue.split(MY_VIN.value).join("xxxx");
            //fieldValue = JSON.stringify(fieldValue, null, 4);
            fieldValue = fieldValue.split("\\n").join("");
            fieldValue = fieldValue.split('\\"').join('"');
			fieldValue = "<textarea rows=2 cols=10>" + fieldValue + "</textarea>";
		}
		if ((currentTable.indexOf(stringToWrite) < 0 ) && ((`${key}`).toUpperCase() != "ID")){ // skip VIN and duplicated values
		   tr = document.createElement("TR");
console.log(">>>>>>>>>>>>>>>>" + (`${key}`).toUpperCase());
			td1= document.createElement("TD");
				td1.innerHTML = fieldName;
				tr.appendChild(td1);

			td2= document.createElement("TD");
				td2.innerHTML = fieldValue;

				if ((fieldName.toUpperCase()).indexOf("PLUGSTATUS") >= 0) { // Extract text corresponding to plugStatus value
					try {
						textValueObject = allowedPlugValues.filter(vals=>vals.number*1.0 === fieldValue*1.0);  // Find element corresponding to field value and get corresponding text
						textValue = textValueObject[0].text;
						dataComment = " (" + textValue + ")";
						td2.innerHTML +=  dataComment;
					} catch (error) {
						dataComment = " (description not found)";
						td2.innerHTML +=  dataComment;
						console.log("WARNING: cannot find text description for plugStatus=" ,fieldValue, ":", error);
						log.value += "\n===WARNING: cannot find text description for plugStatus=" + fieldValue + "\n";
					}
				} else {
					//
				}

				if ((fieldName.toUpperCase()).indexOf("CHARGINGSTATUS") >= 0) { // Extract text corresponding to chargingStatus value
					try {
						textValueObject = allowedChargingValues.filter(vals=>vals.number === fieldValue*1.0) ; // Find element corresponding to field value and get corresponding text
						textValue = textValueObject[0].text;
						dataComment = " (" + textValue + ")";
						td2.innerHTML += dataComment;
					} catch {
						dataComment = " (description not found)";
						td2.innerHTML +=  dataComment;
						console.log("WARNING: cannot find text description for chargingStatus=" ,fieldValue, ":", error);
						log.value += "\n===WARNING: cannot find text description for chargingStatus=" + fieldValue + "\n";
					}
				} else {
					//
				}

                tr.appendChild(td2);

			td3= document.createElement("TD");
				strBegin = path.lastIndexOf("/")+1;
				strtEnd = path.length;
				strLength = strtEnd - strBegin +1;
				td3.innerHTML = path.substr(strBegin,strLength); // endpoint without full path
				tr.appendChild(td3);
			td4 = document.createElement("TD");
				td4.innerHTML = path.substr(0,2); // Endpoint version
				tr.appendChild(td4);

			finalResults.appendChild(tr);
		}
	}
   // finalResults.innerHTML += "</table>";

   return ({ status: "ok_manageOutput", data: response.data })
}

function manageErrors(error,debugPath) {
    if (error.response) {
      console.log(error.response);
		wholeError = error.response;
	    errorMessage = wholeError.data.errors[0].errorMessage;
	    cleanedErrorMessage = errorMessage.split(slash).join(empty); 
		try {
	    	JSONerrorMessage = JSON.parse(cleanedErrorMessage);
			console.log("Axios GET - Final error for endpoint '" + debugPath  + "' :", JSONerrorMessage);
			output.value = "Axios GET - Final error for endpoint '" + debugPath  + "' :" + JSON.stringify(JSONerrorMessage, null, 4);
			return ({"status" : "error", "errorText" : JSONerrorMessage , "JSONerror" : "cleanedErrorMessage"});
		} catch {
			// Non JSON error response
			console.log("Axios POST - Final error for " + debugPath  + " :", cleanedErrorMessage);
			output.value = "Error while decoding JSON error for endpoint " + debugPath + "; raw error message: \n" + cleanedErrorMessage + "\n";
		}
    } else { // no response field in error
		console.log("Axios GET - Unknown error response for endpoint '" + debugPath  + "' :", error);
		output.value = "Axios GET - Unknown error response for endpoint '" + debugPath  + "' , see console for details.";
		return ({"status" : "error", "error" : error });
  }
}


function kamereonMultiGet(id_token) {
	refreshHVACStatus();
	refreshBatteryStatus();
    finalResults.innerHTML = "";

	var hd ={
				headers: {
					'x-gigya-id_token': id_token,
					'apikey': KAMEREON_KEY
				}
			};

	baseUrl = kamereonurl + '/commerce/v1/accounts/' + accountId.value + "/kamereon/kca/car-adapter/";
 	lista = [
		"v1/cars/" + MY_VIN.value + "/" + "cockpit",
		"v1/cars/" + MY_VIN.value + "/" + "location",
		"v1/cars/" + MY_VIN.value + "/" + "battery-status",
		"v2/cars/" + MY_VIN.value + "/" + "battery-status", // There are 2 versions available for battery status
		"v1/cars/" + MY_VIN.value + "/" + "hvac-status",
		"v1/cars/" + MY_VIN.value + "/" + "hvac-settings",
		"v1/cars/" + MY_VIN.value + "/" + "hvac-schedule",
		"v1/cars/" + MY_VIN.value + "/" + "charge-mode",
		"v1/cars/" + MY_VIN.value + "/" + "charging-settings",
		"v1/cars/" + MY_VIN.value + "/" + "charge-schedule",
	];


	const sendGetRequest = async () => {
	for (var i = 0; i < lista.length; i++) {
		path=lista[i];
        fullUrl = baseUrl + lista[i] + "?country=IT";
		log.value += lista[i] + "\n";
	    try {
	        myvar = await axios
			.get(fullUrl,hd)
			.then(response => {
				return manageOutput(response, path);
			})
			.catch((error,path) => {
				return manageErrors(error, path);
         	});
	    } catch (err) {
	        console.error("ASYNC GET ERROR:", err);
	    }
        progress.innerHTML = (((i+1)/lista.length)*100).toFixed(0) + "%"
		if (i+1 == lista.length) {
			log.value += "Done.\n";
		}
	}
console.log("results___=",results);
	}; // Async sendGetRequest() definition

    console.log("sendGetRequest=",sendGetRequest());
	}




function kamereonGet(id_token, path, version) {
// https://github.com/joco73/se.cohen.renaultze/blob/a597635a3a6365be6a8e6edb650a4b8f986b877f/lib/api.js#L372
	console.log("Sending Axios GET request for '" + path + "' using library version " + version + "...");
	log.value = "Sending Axios GET request for '" + path + "' using library version " + version + "...\n";

		if (path.indexOf("?") > 0 ) { // in case quetion mark is included in manual input...
			QUESTION_MARK = "&";
		} else  {
			QUESTION_MARK = "?";
		}

		var fullUrl = kamereonurl + '/commerce/v1/accounts/' + accountId.value + "/kamereon/kca/car-adapter/v" + version + "/cars/" + MY_VIN.value + "/" + path +
			QUESTION_MARK +
			"country=" +
			country.value;

		var hd ={
					headers: {
						'x-gigya-id_token': id_token,
						'apikey': KAMEREON_KEY
					}
				};


		const sendGetRequest = async () => {
		    try {
		        myvar = await axios
				.get(fullUrl,hd)
				.then(response => {
					return manageOutput(response, path);
				})
				.catch((error,path) => {
					debugPath = path;
					return manageErrors(error);
	         	});
		    } catch (err) {
		        console.error("ASYNC GET ERROR:", err);
		    }
console.log("myvar=",myvar);
		}; // Async sendGetRequest() definition

    console.log("sendGetRequest=",sendGetRequest());
	}


function kamereonPost(id_token, path, data, version, sourceField, destField) {
// https://github.com/joco73/se.cohen.renaultze/blob/a597635a3a6365be6a8e6edb650a4b8f986b877f/lib/api.js#L372
	console.log("Sending POST request for '" + path + "' using library version " + version + "...");
	log.value = "Sending POST request for '" + path + "' using library version " + version + "...\n";

	if (path.indexOf("?") > 0 ) { // in case quetion mark is included in manual input...
		QUESTION_MARK = "&";
	} else  {
		QUESTION_MARK = "?";
	}

	var fullUrl = kamereonurl + '/commerce/v1/accounts/' + accountId.value + "/kamereon/kca/car-adapter/v" + version + "/cars/" + MY_VIN.value + "/" + path +
			QUESTION_MARK +
			"country=" + country.value;

console.log("====================POST URL: " + fullUrl);

		return axios.post(
			fullUrl,
			data,
			{
				headers: {
					'Content-type': 'application/vnd.api+json',
					'x-gigya-id_token': id_token,
					'apikey': KAMEREON_KEY,
					//'expiration': 87000
				}
	   		})
			.then(response => {
 				console.log("Axios POST result successful."); //  '" + path +  "' with version " + version + "':" + (JSON.stringify(response.data, null, 4)).replace(MY_VIN.value, "xxx MY VIN xxx"));
 				output.value = "\nAxios POST successful:\n" + (JSON.stringify(response.data, null, 4)).replace(MY_VIN.value, "xxx MY VIN xxx");
                console.log("Source: "+ sourceField + " = '"+ resolvePath(response, sourceField) + "'");
				if ((sourceField !== "") && (destField !== "")) {
					// Update page with POST result data as requested:
					document.getElementById(destField).value = resolvePath(response, sourceField);
				}
				return ({ status: "ok", data: response.id });
			})
			.catch((error) => {
			      if (error.response) {
			        console.log(error.response);
					wholeError = error.response;
                    errorMessage = wholeError.data.errors[0].errorMessage;
                    cleanedErrorMessage = errorMessage.split(slash).join(empty);
					try {
                    	JSONerrorMessage = JSON.parse(cleanedErrorMessage);
					} catch {
						// Non JSON error response
						console.log("Axios POST - Final error for " + path  + " :", cleanedErrorMessage);
						output.value = cleanedErrorMessage;
					return;
					}
					console.log("Axios POST - Final error for " + path  + " :", JSONerrorMessage);
					output.value = JSON.stringify(JSONerrorMessage, null, 4);
			      }
			    }
	);
	}



function getWithVersion(v) {
	log.value ="";
	output.value="";
        kamereonGet(JWT.value, actionEndpoint.value, v)
}


function postWithVersion(v) {
	log.value ="";
	output.value="";
	try {
		body = actionPayloadSpan.value
	} catch(e) {
		log.value = "JSON error parsing payload.\n";
		return;
	}
    kamereonPost(JWT.value, actionEndpoint.value, body, v, "", "")
}



function refreshHVACStatus() {
		log.out = "";
		output.value  = "";
		HVACid.value = "please wait...";
		let body = {
			"data": {
					"type": "RefreshHvacStatus"
				}
		};
		var HVACresult = kamereonPost(JWT.value,  "actions/refresh-hvac-status", body, 1, "data.id", "HVACid")
		console.log("HVACresult prima =",HVACresult);
  		return HVACresult.id
}


function HVAC_on(finalTemp, startDate) {
console.log("Accendo id :",HVACid.value, " in data " , startDate , " a temperatura  " , finalTemp);
		let body = {
			"data": {
					"type": "HvacStart",
					"id": HVACid.value,
					"attributes": {
							"action": "start",
							"id": HVACid.value,
							"targetTemperature": finalTemp,
							"startDateTime": startDate  // "2021-09-29T08:38:00Z"
					}
			}
			};


			console.log(kamereonPost(JWT.value,  "actions/hvac-start", body, 1, "", ""));
			HVACid.value="-";
			//console.log(kamereonGet(JWT.value, "hvac-status", 1));
}

function HVAC_off() {
		let body = {
			"data": {
				"type": "HvacStart",
				"attributes": {
					"action": "stop"
				}
			}
		};
			console.log(kamereonPost(JWT.value,  "actions/hvac-start", body, 1, "", ""));
}



function HVAC_setTemp() {
		let body = {
			"data": {
				"type": "HvacStart",
				"attributes": {
					"action": "start",
							"targetTemperature": HVACtemp.value
				}
			}
		};
			console.log(kamereonPost(JWT.value,  "actions/hvac-start", body, 1, "", ""));
}


function chargeStart() {
		let body = {
			"data": {
				"type": "ChargingStart",
				"attributes": {
					"action": "start"
				}
			}
		}
			console.log(kamereonPost(JWT.value,  "actions/charging-start", body, "", 1, ""));
}

function chargeStop() {
		let body = {
			"data": {
				"type": "ChargingStop",
				"attributes": {
					"action": "stop"
				}
				}
			}
			console.log(kamereonPost(JWT.value,  "actions/charging-start", body, 1, "", ""));
}

function setChargeModeScheduled() {
		let body = {
			"data": {
				"type": "ChargeMode",
				"attributes": {
					"action": "schedule_mode"
				}
				}
			}
			console.log(kamereonPost(JWT.value,  "actions/charge-mode", body, 1, "", ""));
}

function setChargeModeNow() {
		let body = {
			"data": {
				"type": "ChargeMode",
				"attributes": {
					"action": "always_charging"
				}
				}
			}
			console.log(kamereonPost(JWT.value,  "actions/charge-mode", body, 1, "", ""));
}


function refreshBatteryStatus() {
// ok
		log.out = "";
		output.value = "";
		let body = {
				'data': {'type': 'RefreshBatteryStatus'}
			}
			console.log(kamereonPost(JWT.value,  "actions/refresh-battery-status", body,1 ,"", ""));
}


function getAdvancedBatteryStatus() {
// ok, dati avanzati
			console.log(kamereonGet(JWT.value,  "battery-status", 2));
}


function getAdvancedHvacStatus() {
// 404
			console.log(kamereonGet(JWT.value,  "hvac-status", 1));
			console.log(kamereonGet(JWT.value,  "hvac-status", 2));
			console.log(kamereonPost(JWT.value,  "hvac-status", null, 1, "", ""));
			console.log(kamereonPost(JWT.value,  "hvac-status", null, 2, "", ""));
}

function getDoorsStatus() {
//errore
		console.log(kamereonGet(JWT.value,  "lock-status",  1));
		console.log(kamereonGet(JWT.value,  "lock-status",  2));
			console.log(kamereonPost(JWT.value,  "lock-status", null, 1, "", ""));
			console.log(kamereonPost(JWT.value,  "lock-status", null, 2, "", ""));
}


function refreshDoorsStatus() {
// errore
		let body = {
			"data": {
					"type": "RefreshLockStatus"
				}
		};
		console.log(kamereonPost(JWT.value,  "actions/refresh-lock-status", body, 1, "", ""));
}





function horns() {
//		 target  ('horn_lights', 'lights', 'horn')
//		 action  ('stop', 'start', 'double_start')

		attributes = {
			"action": "start",
			"duration": 10,
			"target": "lights",
		};
		let body = {
			"data": {
					"type": "HornLights",
		  			"attributes": attributes
				}
		};
		console.log(kamereonPost(JWT.value,  "actions/horn-lights", body, 1, "", ""));
}




function cockpit() {
// ok, uguale a quell'altro
		console.log(kamereonGet(JWT.value,  "cockpit",  2));
}

function test1() {

		console.log(kamereonGet(JWT.value,  "location",  2));
}


function test2() {

		console.log(kamereonGet(JWT.value,  "hvac-status",  2));
}


function test3() {

		console.log(kamereonGet(JWT.value,  "hvac-status",  2));
}


function test4() {

		console.log(kamereonGet(JWT.value,  "hvac-settings",  2));
}



function test5() {

		console.log(kamereonGet(JWT.value,  "hvac-history",  2));
}


function test6() {
			console.log(kamereonGet(JWT.value,  "hvac-schedule", 2));
}

function test7() {
let body =  {
				'type': 0,
				'start': "2021-09-27T19:43:03.123456Z",
				'end': "2021-09-27T19:43:03.123456Z"
			};
			console.log(kamereonGet(JWT.value,  "hvac-history", body,2));
}




</script>

  </head>
  <body onload="loadEndpoints(); loadPayloads(); createJSrefreshLinks();">
<br>
<center><b>MyRenault vehicle dashboard</b><br>
Created by <a href="https://autoguida.wordpress.com">Jumpjack</a><br>
Version 2.4.0 - 21/10/2021</center><br>
<br>
<br>
mail:<input type="text" id="username" name="username" value=""><br>
password:<input type="password" id="password" name="password" value=""><button id="btnSend" name="btnSend" onclick="main()">Login</button><br>
country:<input type="text" id="country" name="country" value="IT"><br>
<br>
Login steps performed:<br>
<table border=1>
<tr>
<td>App</td><td>JWT</td><td>person</td><td>account</td><td>vehicle</td><td>Login time</td><td>Time remaining</td></tr>
<tr>
<td><span id="login1" name="login1">-</span> <!-- App credentials --></td>
<td><span id="login2" name="login2">-</span> <!-- Get JWT token --></td>
<td><span id="login3" name="login3">-</span> <!-- Get PersonId --></td>
<td><span id="login4" name="login4">-</span> <!-- Get Account Ids --></td>
<td><span id="login5" name="login5">-</span> <!-- Get VIN --></td>
<td><span id="login6" name="login6">-</span></td>
<td><span id="countdown" name="countdown">-</span></td>
</tr>
</table>
<br>
<button onclick="kamereonMultiGet(JWT.value)">Download data</button><br>
Download progress: <span id="progress" name="progess">-</span><br>
<button onclick="refreshBatteryStatus()">Force battery data refresh</button><button onclick="refreshHVACStatus()">Force HVAC data refresh</button>
<table>
<tr>
<td>Output</td><td>Debug log</td><td>Possible errors</td>
</tr>
<tr>

<td>
	<span><textarea id="output" name="output" value="output" cols=60 rows=15></textarea></span>
</td>

<td>
	<span><textarea id="log" name="log" value="" cols=90 rows=15></textarea></span>
</td>

<td>
	400: Syntax error <br>
	401: Unauthorized<br>
	403: Command accepted by server, but forbidden to excute<br>
	404: Command does not exist<br>
	500: Internal Server Error<br>
	501: Not Implemented<br>
	502 Invalid response from the upstream server<br>
 	503: Service Unavailable<br>

</td>

</tr>

</table>
<br><table id="finalResults" name="finalResults" border="1">
<tr>
<td><b>Parameter</b></td>
<td><b>Value</b></td>
<td><b>Endpoint</b></td>
<td><b>Version</b></td>
</tr>
</table>
<br>
<br>
Select endpoint: <select id="EP_list" name="EP_list" onclick="fillEndPoint()" onchange="fillEndPoint()"></select>
<br>
Selected endpoint:<input type="text" id="endpoint" name="endpoint" value="cockpit" size=40>
<button  onclick="justQuery(1)">Query v.1</button>
<button  onclick="justQuery(2)">Query v.2</button><br>
Endpoint description: <span id="endpointDescription" name="endpointDescription">-</span><br>
<br>
Endpoints <a href="https://renault-api.readthedocs.io/en/stable/endpoints.html#vehicle-data-endpoints">guide</a><br>

<br>



	====================== FOR DEVELOPERS ===================<br>
	<input value="./gigya-login.php" id="gigyaPhpLogin" name="gigyaPhpLogin"> <a href="./gigya-login.txt">Download script</a><br>
<!--	Proxy script: <input type="text" id="proxyScript" name="proxyScript" value="http://win98.altervista.org/space/exploration/myp.php" size="100"><br>
	Proxy parameters: <input type="text" id="proxyParams" name="proxyParams" value="?pass=miapass&mode=native&url=" size="100"><br>
	CORS proxy shall allow:<br>
    X-GIGYA-ID_TOKEN,  X-GIGYA-ID-TOKEN, apikey,  expiration, json, fields, login_token, authorization, access_token<br>
-->
	<button onclick="getAllData()">Get all data</button><br>
Endpoint:<br>
<input type="text" id="actionEndpoint" name="actionEndpoint"value="actions/hvac-start"><br>
<button onclick="getWithVersion(1)">GET v.1</button><button onclick="getWithVersion(2)">GET v.2</button><br>
<button onclick="postWithVersion(1)">POST v.1</button><button onclick="postWithVersion(2)">POST v.2</button><br>
<br>
Header payload:
<select id="payloadsList" name="payloadsList" onchange = "fillPayload()"></select>
Successfully tested? <span id="payloadTested" name="payloadTested">-</span><br>
<pre><textarea name="actionPayloadSpan" id="actionPayloadSpan" cols=120 rows=20>

</textarea>
</pre><br>
<br><br>
	<button onclick="refreshHVACStatus()">Get HVAC id</button><input id="HVACid" name="HVACid" value="------" size="50"><br>
	<button onclick="HVAC_on(19, document.getElementById('hvacStartDate').value)">Turn on HVAC</button>
	<input id="hvacStartDate" name="hvacStartDate" value="2021-10-04T13:38:00Z"><br>
	<button onclick="HVAC_setTemp()">Setup HVAC temperature</button>
	<input id="HVACtemp" name="HVACtemp" value=20><br>
	<button onclick="HVAC_off()">Turn off HVAC</button><br>
<br>
	<button onclick="chargeStart()">Start charging</button><br>
	<button onclick="chargeStop()">Stop charging</button><br>
	<button onclick="setChargeModeScheduled()">Set charge mode = scheduled</button><br>
	<button onclick="setChargeModeNow()">Set charge mode = now</button><br>
	<!--<button onclick="setChargeSchedule()">Setup charge schedule</button><br>-->
<br>
	<button onclick="getAdvancedBatteryStatus()">Get advanced battery status</button><br>
<button onclick="sendManualUrl()">Send this url:</button><br>
<textarea id="manualUrl" name="manualUrl" cols=100 rows=5></textarea><br>

<br>
<a href="https://renault-wrd-prod-1-euw1-myrapp-one.s3-eu-west-1.amazonaws.com/configuration/android/config_it_IT.json">Gigya apikey e Kamereon Apikey - credentials file</a>
<br>

Gigya api key: <input type="text" id="gapikey" name="gapikey" size=100 value="3_js8th3jdmCWV86fKR3SXQWvXGKbHoWFv8NAgRbH7FnIBsi_XvCpN_rtLcI07uNuq"><br>
Kamereon key: <input type="text" id="kapikey" name="kapikey" size=100  value="Ae9FDWugRxZQAGm3Sxgk7uJn6Q4CGEA2"><br>
<br>
cookieValue:    <input type="text" id="cookieValue" name="cookieValue" value=""  size = 100><br>
Id_token (JWT): <input type="text" id="JWT" name="JWT" value="" size=100><br>
Person Id:      <input type="text" id="personId" name="personId" value="" size = 50><br>
1st account:    <input type="text" id="accountId" name="accountId" value="" size=100> - Type: <input type="text" id="accountIdType" name="accountIdType" value="" size=10> <br>
2nd account:    <input type="text" id="accountId2" name="accountId2" value="" size=100> - Type: <input type="text" id="accountId2Type" name="accountId2Type" value="" size=10> <br>
VIN:            <input type="text" id="MY_VIN" name="MY_VIN" value="-"><br>
<hr>
<br><b><big>Manual login and test</big></b><br>
Copy this payload into <a href="http://www.reqbin.com">reqbin.com</a> to manually log in:<br>
<span id="loginPayloadForReqbin" name="loginPayload">-</span><br>
Try this link: <br>
<span id="testUrlReqbin" name="testUrlReqbin">-</span><br>
<br>
<br>
Click on these links to force refresh of the scripts:<br>
<span id="links" name="links">-</span><br>
<br>

	<span id="status" name="status">-</span><br>

  </body>


</html>
